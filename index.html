<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>Hledger V22</title>
    <meta name="description" content="Offline CLI Accounting Tool">
    
    <!-- 1. PWA MANIFEST (Base64 Embedded - Same technique as Esnaf) -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkhsZWRnZXIgVjIyIiwKICAic2hvcnRfbmFtZSI6ICJITGVkZ2VyIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwZjE3MmEiLAogICJ0aGVtZV9jb2xvciI6ICIjMGYxNzJhIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNRiY3B6ZEhWamFEd3hNREF3TVRnd01DQlRaV2Q4WDI1bIyNDhMM1JoY201emRHRnNaUzVoYldVOUlqeHdZWFJvT2lBOUlqQWdNQ0ExTVRJeE1USWlQajxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiBmaWxsPSIjMGYxNzJhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGR5PSIuM2VtIiBmaWxsPSIjMzhiZGY4IiBmb250LXNpemU9IjIwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC13ZWlnaHQ9ImJvbGQiPiZndDtfPC90ZXh0Pjwvc3ZnPg==",\n      "sizes": "512x512",\n      "type": "image/svg+xml"\n    }\n  ]\n}">

    <!-- 2. META TAGS -->
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hledger">

    <!-- 3. ICONS (Base64) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzBmMTcyYSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkeT0iLjNlbSIgZmlsbD0iIzM4YmRmOCIgZm9udC1zaXplPSIyMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiIGZvbnQtd2VpZ2h0PSJib2xkIj4mZ3Q7XzwvdGV4dD48L3N2Zz4=">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzBmMTcyYSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkeT0iLjNlbSIgZmlsbD0iIzM4YmRmOCIgZm9udC1zaXplPSIyMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiIGZvbnQtd2VpZ2h0PSJib2xkIj4mZ3Q7XzwvdGV4dD48L3N2Zz4=">

    <style>
        :root {
            --bg: #0f172a; --panel: #1e293b; --text: #e2e8f0;
            --primary: #38bdf8; --accent: #64748b; --ghost: #475569;
            --warn: #fbbf24; --error: #f87171; --success: #4ade80;
            --font: 'Menlo', 'Consolas', 'Fira Code', monospace;
            --font-size: 13px;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        [data-theme="matrix"] { --bg:#000; --panel:#0a0a0a; --text:#0f0; --primary:#0f0; --accent:#008f11; --ghost:#003300; --error:#f00; }
        [data-theme="dracula"] { --bg:#282a36; --panel:#44475a; --text:#f8f8f2; --primary:#ff79c6; --accent:#6272a4; --ghost:#6272a4; }
        [data-theme="paper"] { --bg:#fff; --panel:#f3f4f6; --text:#111; --primary:#000; --accent:#9ca3af; --ghost:#d1d5db; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; overscroll-behavior: none; }
        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: var(--font); position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; overflow: hidden; 
        }

        #status-bar { 
            padding: 8px 1rem; padding-top: env(safe-area-inset-top, 8px); font-size: 11px; 
            background: var(--panel); color: var(--accent); 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--accent); flex-shrink: 0; height: calc(40px + env(safe-area-inset-top, 0));
        }
        #status-right { display: flex; gap: 10px; align-items: center; }
        #strict-badge { color: var(--warn); display: none; font-weight: bold; border: 1px solid var(--warn); padding: 0 4px; border-radius: 3px; }
        
        /* PWA Install Button */
        #install-btn { 
            color: var(--bg); background: var(--primary); 
            display: none; font-weight: bold; border: 1px solid var(--primary); 
            padding: 2px 8px; border-radius: 3px; cursor: pointer; 
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

        #ledger-badge { text-transform: uppercase; letter-spacing: 1px; }

        #terminal-container { 
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; 
            scroll-behavior: smooth; -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain;
        }
        #terminal-content { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; padding: 1rem; padding-bottom: 10px; }
        
        .line { margin-bottom: 6px; word-break: break-word; font-size: var(--font-size); line-height: 1.5; }
        .line.cmd { color: var(--accent); margin-top: 1rem; padding-top: 0.5rem; border-top: 1px solid var(--panel); opacity: 0.8; }
        .line.cmd::before { content: "➜ "; color: var(--primary); }
        .line.system { color: var(--accent); font-style: italic; }
        .line.error { color: var(--error); }
        .line.success { color: var(--success); }

        /* Tree Visualization */
        .tree-container { margin-top: 8px; border-left: 1px solid var(--accent); padding-left: 4px; }
        .tree-item { display: flex; align-items: center; padding: 2px 0; }
        .tree-marker { color: var(--accent); margin-right: 6px; font-family: monospace; }
        .tree-name { color: var(--text); cursor: pointer; transition: color 0.2s; }
        .tree-name:hover { color: var(--primary); text-decoration: underline; }
        .tree-name.explicit { font-weight: bold; color: var(--primary); } 

        /* Reports & Dash */
        .pnl-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed var(--panel); }
        .pnl-head { font-weight: bold; color: var(--primary); margin-top: 8px; border-bottom: 1px solid var(--accent); padding-bottom: 2px; }
        .pnl-total { font-weight: bold; border-top: 1px solid var(--text); margin-top: 4px; padding-top: 4px; color: var(--text); }
        .budget-row { margin-bottom: 8px; }
        .budget-label { display: flex; justify-content: space-between; font-size: 11px; opacity: 0.8; margin-bottom: 2px; }
        .budget-track { height: 8px; background: var(--panel); border-radius: 4px; overflow: hidden; }
        .budget-fill { height: 100%; background: var(--success); transition: width 0.3s; }
        .budget-fill.warn { background: var(--warn); }
        .budget-fill.over { background: var(--error); }
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .dash-card { background: var(--panel); padding: 10px; border-radius: 6px; border: 1px solid var(--accent); display: flex; flex-direction: column; }
        .dash-label { font-size: 10px; text-transform: uppercase; color: var(--accent); margin-bottom: 4px; }
        .dash-val { font-size: 16px; font-weight: bold; color: var(--text); }
        .dash-row { grid-column: span 2; }
        .txn-id { color: var(--accent); font-size: 10px; margin-right: 8px; opacity: 0.7; }

        /* Input */
        #input-wrapper { background: var(--panel); padding: 8px; padding-bottom: max(8px, var(--safe-bottom)); box-shadow: 0 -4px 20px rgba(0,0,0,0.3); z-index: 999; border-top: 1px solid var(--accent); flex-shrink: 0; }
        #suggestions-container { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; height: 30px; }
        #context-badge { background: var(--bg); color: var(--accent); border: 1px solid var(--accent); padding: 0 8px; border-radius: 4px; font-size: 11px; white-space: nowrap; text-transform: uppercase; letter-spacing: 0.5px; flex-shrink: 0; cursor: pointer; user-select: none; font-weight: bold; min-width: 45px; text-align: center; height: 26px; display: flex; align-items: center; justify-content: center; }
        #context-badge:active { background: var(--accent); color: var(--bg); }
        #context-badge.hidden { display: none; }
        #suggestions { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; flex: 1; height: 100%; align-items: center; }
        .chip { background: var(--bg); color: var(--text); padding: 0 10px; border-radius: 4px; font-size: 12px; white-space: nowrap; border: 1px solid var(--accent); cursor: pointer; opacity: 0.9; text-transform: lowercase; transition: background 0.2s; height: 26px; display: flex; align-items: center; }
        .chip:active { background: var(--primary); color: var(--bg); }
        .chip.hint { border: 1px dashed var(--accent); opacity: 0.6; cursor: default; font-style: italic; }
        .chip.math { border: 1px solid var(--success); color: var(--success); font-weight: bold; background: rgba(74, 222, 128, 0.1); }
        .input-stack { position: relative; display: flex; align-items: center; background: var(--bg); border: 1px solid var(--accent); border-radius: 6px; padding: 0 8px 0 12px; height: 44px; }
        .prompt { color: var(--primary); font-weight: bold; margin-right: 8px; white-space: pre; }
        #cmd-input, #ghost-text { font-family: var(--font); font-size: 16px; position: absolute; left: 30px; right: 50px; top: 0; bottom: 0; background: transparent; border: none; outline: none; display: flex; align-items: center; padding: 0; margin: 0; text-transform: lowercase; }
        #cmd-input { z-index: 2; color: var(--text); width: calc(100% - 80px); }
        #ghost-text { z-index: 1; color: var(--ghost); pointer-events: none; white-space: pre; overflow: hidden; }
        #tab-btn { position: absolute; right: 4px; z-index: 10; background: var(--panel); color: var(--primary); border: 1px solid var(--accent); border-radius: 4px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        #tab-btn.visible { opacity: 1; pointer-events: auto; }

        #editor-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s ease; }
        #editor-modal.open { transform: translateY(0); }
        #editor-toolbar { padding: 1rem; padding-top: max(1rem, env(safe-area-inset-top)); background: var(--panel); border-bottom: 1px solid var(--accent); display: flex; justify-content: space-between; align-items: center; }
        #raw-editor { flex: 1; background: var(--bg); color: var(--text); border: none; padding: 1rem; font-family: var(--font); font-size: 14px; resize: none; outline: none; white-space: pre; }
        .btn { padding: 6px 12px; border-radius: 4px; font-weight: bold; border: none; cursor: pointer; }
        .btn-primary { background: var(--primary); color: var(--bg); }
        .btn-text { background: transparent; color: var(--error); }
        .btn-icon { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
        body.wizard-mode .prompt { color: var(--warn); }
    </style>
</head>
<body>

<div id="status-bar">
    <span>HLEDGER V22</span>
    <div id="status-right">
        <span id="install-btn" onclick="installApp()">INSTALL</span>
        <span id="strict-badge">STRICT</span>
        <span id="ledger-badge">default</span>
    </div>
</div>

<div id="terminal-container">
    <div id="terminal-content">
        <div class="line system">Architect Engine Loaded.</div>
        <div class="line system">Try 'coa', 'coa add', or 'man coa'.</div>
    </div>
</div>

<div id="input-wrapper">
    <div id="suggestions-container">
        <div id="context-badge" class="hidden" onmousedown="event.preventDefault()" onclick="cycleContext()"></div>
        <div id="suggestions"></div>
    </div>
    <div class="input-stack">
        <span class="prompt" id="prompt-char">$</span>
        <div id="ghost-text"></div>
        <input type="text" id="cmd-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        <div id="tab-btn" onmousedown="event.preventDefault()" onclick="acceptGhost()">➜</div>
    </div>
</div>

<input type="file" id="file-input" style="display:none">

<div id="editor-modal">
    <div id="editor-toolbar">
        <button class="btn btn-text" onclick="window.Editor.close()">Cancel</button>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn btn-icon" onclick="window.Editor.copy()" id="copy-btn">Copy</button>
            <button class="btn btn-primary" onclick="window.Editor.save()">Save</button>
        </div>
    </div>
    <textarea id="raw-editor" spellcheck="false"></textarea>
</div>

<script>
/* =========================================
   4. SERVICE WORKER INJECTION (The "Esnaf" Method)
   ========================================= */
window.onload = () => {
    if('serviceWorker' in navigator){
        // Dynamic SW for Single File Offline Capability
        const swCode = `
        const CACHE_NAME = 'hledger-v22-offline';
        self.addEventListener('install', e => { 
            e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.add('.'))); 
            self.skipWaiting(); 
        });
        self.addEventListener('activate', e => self.clients.claim());
        self.addEventListener('fetch', e => {
            e.respondWith(
                fetch(e.request)
                .then(res => { 
                    const c = res.clone(); 
                    caches.open(CACHE_NAME).then(cache => cache.put(e.request, c)); 
                    return res; 
                })
                .catch(() => caches.match(e.request))
            );
        });`;
        
        const blob = new Blob([swCode], {type: 'text/javascript'});
        // We use .catch() here so if GitHub Pages blocks the blob, 
        // the app DOES NOT CRASH and still runs (just maybe without offline support)
        navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => console.log('SW Error (Ignored)'));
    }
    
    LedgerManager.load();
    run('dash');
    updatePrediction();
};

/* =========================================
   PWA INSTALL UI LOGIC
   ========================================= */
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const btn = document.getElementById('install-btn');
    if(btn) btn.style.display = 'inline';
});

async function installApp() {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
        document.getElementById('install-btn').style.display = 'none';
    }
    deferredPrompt = null;
}

/* =========================================
   MANUAL PAGES
   ========================================= */
const MAN_PAGES = {
    'coa': `<div class="man-title">coa</div><div>Chart of Accounts Manager.</div><div class="man-sect">Usage</div><span class="man-code">coa</span> (View tree)<br><span class="man-code">coa add &lt;name&gt;</span> (Create account)<br><span class="man-code">coa list</span> (Flat list)<br><span class="man-code">coa &lt;filter&gt;</span> (Filter tree) <div class="man-sect">Details</div><div>Use <b>add</b> to explicitly define accounts, which is required for Strict Mode.</div>`,
    'add': `<div class="man-title">add</div><div>Transaction Wizard.</div>`,
    'strict': `<div class="man-title">strict</div><div>Toggle Strict Mode.</div><div>When ON, only accounts defined via 'coa add' or 'account' directives are allowed in transactions.</div>`,
    'bs': `<div class="man-title">bs</div><div>Balance Sheet.</div>`,
    'check': `<div class="man-title">check</div><div>Integrity Check.</div>`
};

/* =========================================
   CORE UTILS
   ========================================= */
const MathEngine = {
    eval(str) {
        if (!str || /^\d{4}-\d{1,2}/.test(str) || !/[\+\-\*\/]/.test(str) || !/^[\d\.\+\-\*\/\(\)\s]+$/.test(str)) return null;
        try { const res = new Function('return ' + str)(); if (isFinite(res) && !isNaN(res) && res.toString() !== str.trim()) return res.toFixed(2); } catch(e) {} return null;
    }
};

function match(t, q) {
    if(!q) return true; const s = q.toLowerCase();
    if (s.startsWith('date:')) return t.date.startsWith(s.substring(5));
    if (s.startsWith('amt:')) {
        const cond = s.substring(4);
        const val = parseFloat(cond.replace(/[><]/,''));
        if (isNaN(val)) return true;
        if (cond.startsWith('>')) return t.posts.some(p => Math.abs(p.amt) > val);
        if (cond.startsWith('<')) return t.posts.some(p => Math.abs(p.amt) < val);
        return t.posts.some(p => Math.abs(p.amt) === val);
    }
    return t.desc.toLowerCase().includes(s) || t.posts.some(p=>p.acc.includes(s));
}

const SETTINGS = { strictMode: localStorage.getItem('HL_STRICT')==='true', toggleStrict() { this.strictMode = !this.strictMode; localStorage.setItem('HL_STRICT', this.strictMode); updateStrictUI(); return this.strictMode; } };
function updateStrictUI() { document.getElementById('strict-badge').style.display = SETTINGS.strictMode ? 'inline' : 'none'; } updateStrictUI();

/* =========================================
   MANAGERS
   ========================================= */
const ThemeManager = {
    init() { const t = JSON.parse(localStorage.getItem('HL_THEME_CFG')||'{}'); if(t.preset) this.setPreset(t.preset); if(t.font) this.setFont(t.font); if(t.bg) this.setBg(t.bg); if(t.text) this.setText(t.text); },
    save(k, v) { const t = JSON.parse(localStorage.getItem('HL_THEME_CFG')||'{}'); t[k] = v; localStorage.setItem('HL_THEME_CFG', JSON.stringify(t)); },
    setPreset(name) { document.documentElement.setAttribute('data-theme', name); this.save('preset', name); },
    setFont(size) { document.documentElement.style.setProperty('--font-size', size); this.save('font', size); },
    setBg(color) { document.documentElement.style.setProperty('--bg', color); this.save('bg', color); },
    setText(color) { document.documentElement.style.setProperty('--text', color); this.save('text', color); },
    reset() { localStorage.removeItem('HL_THEME_CFG'); document.documentElement.removeAttribute('data-theme'); document.documentElement.style = ''; this.setPreset('default'); }
}; ThemeManager.init();

const AliasManager = {
    aliases: JSON.parse(localStorage.getItem('HL_ALIASES')||'{}'),
    set(key, val) { this.aliases[key] = val; this.save(); },
    remove(key) { delete this.aliases[key]; this.save(); },
    resolve(input) { return this.aliases[input] || input; },
    save() { localStorage.setItem('HL_ALIASES', JSON.stringify(this.aliases)); },
    list() { return this.aliases; }
};

const BudgetManager = {
    budgets: JSON.parse(localStorage.getItem('HL_BUDGETS')||'{}'),
    set(cat, amt) { this.budgets[cat] = parseFloat(amt); this.save(); },
    remove(cat) { delete this.budgets[cat]; this.save(); },
    get() { return this.budgets; },
    save() { localStorage.setItem('HL_BUDGETS', JSON.stringify(this.budgets)); }
};

const LedgerManager = {
    current: localStorage.getItem('HL_META')||'default',
    list: () => Object.keys(localStorage).filter(k=>k.startsWith('HL_DATA_')).map(k=>k.replace('HL_DATA_','')),
    load() {
        let data = localStorage.getItem('HL_DATA_' + this.current);
        if (!data) { data = "; hledger init\n2023-01-01 opening\n    assets:bank  $1000\n    equity:open\n"; localStorage.setItem('HL_DATA_' + this.current, data); }
        parseData(data); document.getElementById('ledger-badge').innerText = this.current;
    },
    switch(n) { this.current = n.toLowerCase(); localStorage.setItem('HL_META', this.current); this.load(); },
    save(d) { localStorage.setItem('HL_DATA_' + this.current, d); },
    getRaw() { return localStorage.getItem('HL_DATA_' + this.current); },
    append(text) { this.save(this.getRaw() + "\n" + text); this.load(); },
    delete(index) {
        const txns = [...transactions]; if (index < 0 || index >= txns.length) return false;
        txns.splice(index, 1); 
        // Reconstruct including directives
        const oldRaw = this.getRaw();
        const directives = oldRaw.split('\n').filter(l => l.startsWith('account ') || l.startsWith('alias ') || l.startsWith(';'));
        let out = directives.join('\n') + "\n";
        txns.forEach(t => { out += `\n${t.date} ${t.desc}\n`; t.posts.forEach(p => { out += `    ${p.acc}    ${p.amt}\n`; }); });
        this.save(out); this.load(); return true;
    }
};

/* =========================================
   PARSER
   ========================================= */
let transactions = [];
let definedAccounts = new Set(); // Explicitly defined via 'account'

function parseData(source) {
    transactions = []; 
    const accSet = new Set();
    definedAccounts = new Set(); // Reset
    
    const lines = source.split('\n'); 
    let txn = null;
    
    lines.forEach(line => {
        const clean = line.split(';')[0].trimEnd(); 
        if (!clean) return;
        
        // Account Directive
        if (clean.startsWith('account ')) {
            const accName = clean.substring(8).trim();
            definedAccounts.add(accName);
            accSet.add(accName);
            return;
        }

        const dMatch = clean.match(/^(\d{4}[-/.]\d{2}[-/.]\d{2})\s+(.*)$/);
        const pMatch = clean.match(/^\s+([\w:]+)(?:\s{2,}(.*))?$/);
        
        if (dMatch) { 
            if (txn) transactions.push(finalize(txn, transactions.length)); 
            txn = { id: transactions.length, date: dMatch[1], desc: dMatch[2], posts: [] }; 
        } 
        else if (pMatch && txn) { 
            const acc = pMatch[1].toLowerCase(); 
            accSet.add(acc); 
            txn.posts.push({ acc: acc, amtRaw: pMatch[2] }); 
        }
    });
    if (txn) transactions.push(finalize(txn, transactions.length)); 
    ENGINE.accounts = Array.from(accSet).sort(); 
}
function finalize(txn, id) {
    let bal = 0, nullPost = null; txn.id = id;
    txn.posts.forEach(p => { 
        p.amt = 0; 
        if(!p.amtRaw) { nullPost=p; } else {
            if (p.amtRaw.split('-').length > 2) { p.amt = 0; } else {
                const clean = p.amtRaw.replace(/[^\d.-]/g,'');
                if (!isNaN(parseFloat(clean))) p.amt = parseFloat(clean);
            }
            bal += p.amt; 
        }
    });
    if(nullPost) nullPost.amt = -bal;
    return txn;
}

/* =========================================
   AI ENGINE
   ========================================= */
const ENGINE = {
    schema: {
        'coa': { type: 'branch', branches: { 'add': {type:'hint',text:'<name>'}, 'list':{type:'info',text:'flat list'} }, dynamic: () => ['<filter>'] },
        'bs': { type: 'info', text: 'balance sheet' },
        'check': { type: 'info', text: 'integrity check' },
        'man': { type: 'enum', options: () => Object.keys(MAN_PAGES) },
        'dash': { type: 'info', text: 'show dashboard' },
        'edit': { type: 'info', text: 'open raw editor' },
        'undo': { type: 'info', text: 'revert last txn' },
        'stats': { type: 'info', text: 'file metrics' },
        'strict': { type: 'info', text: 'toggle validation' },
        'clear': { type: 'info', text: 'clear screen' },
        'help': { type: 'info', text: 'show command list' },
        'forecast': { type: 'info', text: 'project balance' },
        'import': { type: 'branch', branches: { 'replace': {type:'info',text:'overwrite'}, 'append': {type:'info',text:'add'} } },
        'export': { type: 'branch', branches: { 'copy': {type:'info',text:'to clipboard'}, 'file': {type:'info',text:'download'} } },
        'budget': { type: 'branch', branches: { 'rm': { type: 'enum', options: () => Object.keys(BudgetManager.get()) } }, dynamic: () => Object.keys(BudgetManager.get()) },
        'alias': { type: 'branch', branches: { 'list': {type:'info',text:'show all'}, 'rm': { type: 'enum', options: () => Object.keys(AliasManager.list()) } } },
        'recur': { type: 'query', hint: '<search>' },
        'rm': { type: 'query', hint: '<id>' },
        'theme': { type: 'branch', branches: { 'default': null, 'matrix': null, 'dracula': null, 'paper': null, 'font': { type: 'params', options: ['12px', '14px', '16px', '18px'] }, 'bg': { type: 'hint', text: '#hex' }, 'text': { type: 'hint', text: '#hex' }, 'reset': null } },
        'ledger': { type: 'branch', branches: { 'list': null, 'new': { type: 'hint', text: '<name>' }, 'switch': { type: 'enum', options: () => LedgerManager.list() } } },
        'graph': { type: 'branch', branches: { 'trend': { type: 'params', options: ['filter:', 'sort:', 'date:'] }, 'exp': { type: 'params', options: ['filter:', 'sort:', 'date:'] }, 'pie': { type: 'params', options: ['filter:', 'date:'] } } },
        'pnl': { type: 'query' }, 'bal': { type: 'query' }, 'reg': { type: 'query' },
        'add': { type: 'info', text: 'new transaction' }, 'reset': { type: 'info', text: 'reset theme' }
    },
    accounts: [],
    predict(input) {
        if (!input) return { suggest: '', context: 'Command', options: Object.keys(this.schema).map(k=>({text:k, type:'cmd'})) };
        const parts = input.split(' '); const cmd = parts[0]; const lastArg = parts[parts.length - 1];
        if (parts.length === 1) {
            const matches = Object.keys(this.schema).filter(k => k.startsWith(cmd));
            if (matches.length === 1 && matches[0] !== cmd) return { suggest: matches[0].substring(cmd.length), context:'Command', options: matches.map(k=>({text:k, type:'cmd'})) };
            if (matches.length > 0 && input.endsWith(' ')) return this.getNextStep(cmd, [], '');
            return { suggest: '', context:'Command', options: matches.map(k=>({text:k, type:'cmd'})) };
        }
        return this.getNextStep(cmd, parts.slice(1), lastArg);
    },
    getNextStep(cmd, args, lastArg) {
        const node = this.schema[cmd]; if (!node) return { suggest: '', options: [] };
        if (node.type === 'info') return { suggest: '', context: 'Info', options: [{ isHint: true, text: node.text, type:'info' }] };
        if (node.type === 'branch') {
            const subCmd = args[0];
            if ((cmd==='budget'||cmd==='coa') && args.length===0 && !lastArg.endsWith(' ') && node.dynamic) return { suggest: '', context:'Option', options: node.dynamic().concat(Object.keys(node.branches)).map(k=>({text:k, type:'opt'})) };
            
            if (!subCmd || (args.length === 1 && !lastArg.endsWith(' '))) {
                const options = Object.keys(node.branches); const matches = options.filter(o => o.startsWith(lastArg || ''));
                let ghost = ''; if (matches.length === 1 && subCmd && matches[0] !== subCmd) ghost = matches[0].substring(subCmd.length);
                return { suggest: ghost, context:'Subcmd', options: matches.map(k=>({text:k, type:'opt'})) };
            }
            if (node.branches[subCmd]) {
                const subNode = node.branches[subCmd];
                if (subNode.type === 'params') return this.getParamPrediction(args.slice(1), lastArg, subNode.options);
                if (subNode.type === 'hint' || subNode.type === 'info') return { suggest: '', context:'Input', options: [{ isHint: true, text: subNode.text, type:'info' }] };
                if (subNode.type === 'enum') return this.getEnumPrediction(args[1], subNode.options());
            }
        }
        if (node.type === 'enum') return this.getEnumPrediction(args[0], node.options());
        if (node.type === 'query' || lastArg.includes(':')) return this.getCompositePrediction(lastArg, node.context || 'Filter');
        return { suggest: '', context:'Unknown', options: [] };
    },
    getEnumPrediction(curr, opts) {
        const matches = opts.filter(o => o.startsWith(curr||'')); let ghost = '';
        if (matches.length > 0 && curr && matches[0] !== curr) ghost = matches[0].substring(curr.length);
        return { suggest: ghost, context:'Option', options: matches.map(k=>({text:k, type:'opt'})) };
    },
    getParamPrediction(args, lastArg, validParams) {
        if (!lastArg.includes(':')) {
             const matches = validParams.filter(p => p.startsWith(lastArg));
             return { suggest: matches.length===1?matches[0].substring(lastArg.length):'', context:'Param', options: matches.map(k=>({text:k, type:'param'})) };
        }
        return this.getCompositePrediction(lastArg, 'Value');
    },
    getCompositePrediction(str, contextLabel) {
        const [key, val] = str.includes(':') ? str.split(':') : ['', str];
        const prefix = str.includes(':') ? key + ':' : ''; const search = val || key;
        let results = [];
        const accMatches = this.accounts.filter(a => a.includes(search || ''));
        accMatches.forEach(a => results.push({ text: prefix + a, type: 'acc' }));
        if (!str.includes(':') || key === 'date') {
            const d = new Date(); const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0');
            if (('date:'+y).startsWith(str)) results.push({ text: `date:${y}`, type: 'date' });
            if (('date:'+y+'-'+m).startsWith(str)) results.push({ text: `date:${y}-${m}`, type: 'date' });
        }
        if (!str.includes(':') || key === 'depth') { ['depth:2', 'depth:3'].forEach(o => { if(o.startsWith(str)) results.push({ text: o, type: 'cmd' }); }); }
        if (!str.includes(':') || key === 'amt') { ['amt:>', 'amt:<'].forEach(o => { if(o.startsWith(str)) results.push({ text: o, type: 'param' }); }); }
        
        const finalOptions = results.filter(o => o.text.startsWith(str));
        let ghost = '';
        if (finalOptions.length > 0) { const strict = finalOptions.find(a => a.text.startsWith(str)); if (strict) ghost = strict.text.substring(str.length); }
        return { suggest: ghost, context: contextLabel, options: finalOptions };
    }
};

/* =========================================
   UI & COMMANDS
   ========================================= */
const content = document.getElementById('terminal-content');
const container = document.getElementById('terminal-container');
const input = document.getElementById('cmd-input');
const ghost = document.getElementById('ghost-text');
const suggs = document.getElementById('suggestions');
const tabBtn = document.getElementById('tab-btn');
const inputWrapper = document.getElementById('input-wrapper');
const fileInput = document.getElementById('file-input');
const ctxBadge = document.getElementById('context-badge');

let wizard = null; let importMode = 'append'; let activeFilter = 'all'; 

function log(msg, type='text') {
    const div = document.createElement('div'); div.className = `line ${type}`; div.innerHTML = msg;
    content.appendChild(div); container.scrollTop = container.scrollHeight;
}

function run(raw) {
    const val = raw.trim().toLowerCase();
    if (wizard) { return Wizard.step(val); }
    if (!val) return; 
    log(val, 'cmd');
    const mathRes = MathEngine.eval(val);
    if (mathRes !== null && !ENGINE.schema[val.split(' ')[0]]) { log(`= ${mathRes}`, 'success'); return; }
    
    const parts = val.split(' '); const verb = parts[0]; const args = parts.slice(1);

    if (verb === 'coa') {
        if (args[0] === 'add') {
            if (!args[1]) return log("Usage: coa add <name>", 'warn');
            LedgerManager.append(`account ${args[1]}`);
            log(`Account '${args[1]}' created.`, 'success');
        } else if (args[0] === 'list') {
            log(ENGINE.accounts.join('<br>'));
        } else {
            renderCOA(args.join(' '));
        }
    }
    else if (verb === 'check') {
        let errs = 0; transactions.forEach(t=>{ let sum=0; t.posts.forEach(p=>sum+=p.amt); if(Math.abs(sum)>0.01){errs++; log(`Txn #${t.id} unbalanced: ${sum.toFixed(2)}`,'error');}});
        if(errs===0) log("Integrity Check Passed.",'success'); else log(`Found ${errs} errors.`,'warn');
    }
    else if (verb === 'bs') {
        let assets=0, liab=0, equity=0, income=0, expenses=0; const q = args.join(' ');
        transactions.filter(t => match(t, q)).forEach(t => {
            t.posts.forEach(p => {
                if (p.acc.startsWith('assets')) assets += p.amt;
                else if (p.acc.startsWith('liabilities')) liab += p.amt;
                else if (p.acc.startsWith('equity')) equity += p.amt;
                else if (p.acc.startsWith('income')) income += p.amt;
                else if (p.acc.startsWith('expenses')) expenses += p.amt;
            });
        });
        const retained = income + expenses; const netWorth = assets + liab;
        log(`<div class="pnl-head">Balance Sheet ${q?'('+q+')':''}</div><div class="pnl-row"><span>Assets</span><span style="color:var(--success)">${assets.toFixed(2)}</span></div><div class="pnl-row"><span>Liabilities</span><span style="color:var(--error)">${liab.toFixed(2)}</span></div><div class="pnl-row"><span>Equity</span><span>${equity.toFixed(2)}</span></div><div class="pnl-row"><span>Retained Earnings</span><span>${retained.toFixed(2)}</span></div><div class="pnl-row pnl-total"><span>Net Worth</span><span>${netWorth.toFixed(2)}</span></div>`);
    }
    else if (verb === 'man') {
        const topic = args[0];
        if (!topic) log("Usage: man <command>. Type 'man' to see list.", 'warn');
        else if (MAN_PAGES[topic]) log(MAN_PAGES[topic]);
        else log("No manual entry for " + topic, 'error');
    }
    else if (verb === 'dash') {
        let income = 0, expenses = 0, assets = 0; const now = new Date(); const ym = now.toISOString().slice(0, 7);
        transactions.forEach(t => { t.posts.forEach(p => { if (p.acc.startsWith('assets')) assets += p.amt; if (t.date.startsWith(ym)) { if (p.acc.startsWith('income')) income += p.amt; if (p.acc.startsWith('expenses')) expenses += p.amt; } }); });
        log(`<div class="dash-grid"><div class="dash-card"><div class="dash-label">Net Worth</div><div class="dash-val">$${assets.toFixed(0)}</div></div><div class="dash-card"><div class="dash-label">Burn Rate (Mo)</div><div class="dash-val" style="color:var(--error)">$${expenses.toFixed(0)}</div></div><div class="dash-card dash-row"><div class="dash-label">Income (This Month)</div><div class="dash-val" style="color:var(--success)">$${Math.abs(income).toFixed(0)}</div></div></div>`);
    }
    else if (verb === 'stats') {
        const txCount = transactions.length; const accCount = ENGINE.accounts.length; const first = transactions[0]?.date || 'N/A'; const last = transactions[txCount-1]?.date || 'N/A';
        log(`<div class="stat-row"><span>Transactions</span><span>${txCount}</span></div><div class="stat-row"><span>Accounts</span><span>${accCount}</span></div><div class="stat-row"><span>Date Range</span><span>${first} to ${last}</span></div><div class="stat-row"><span>Ledger Size</span><span>${(LedgerManager.getRaw().length/1024).toFixed(1)} KB</span></div>`);
    }
    else if (verb === 'rm') {
        const id = parseInt(args[0]); if (isNaN(id)) return log("Usage: rm <id>", 'warn');
        if (LedgerManager.delete(id)) log(`Transaction #${id} deleted.`, 'success'); else log(`ID #${id} not found.`, 'error');
    }
    else if (verb === 'reg') {
        const subset = transactions.slice(-30).filter(t => match(t, args.join(' ')));
        if (!subset.length) return log("No matches.", 'system');
        subset.forEach(t => {
            const posts = t.posts.map(p => `<div style="display:flex;justify-content:space-between;padding-left:10px;font-size:0.9em;opacity:0.8"><span>${p.acc}</span><span class="${p.amt<0?'neg':''}">${(p.amt||0).toFixed(2)}</span></div>`).join('');
            log(`<div style="margin-top:10px;border-left:2px solid var(--accent);padding-left:8px;"><div style="color:var(--primary)"><span class="txn-id">#${t.id}</span>${t.date} <span style="color:var(--text)">${t.desc}</span></div>${posts}</div>`);
        });
    }
    else if (verb === 'edit') window.Editor.open();
    else if (verb === 'import') { importMode = args[0] === 'replace' ? 'replace' : 'append'; fileInput.click(); }
    else if (verb === 'forecast') {
        const now = new Date(); const past90 = new Date(now); past90.setDate(now.getDate() - 90); const iso90 = past90.toISOString().slice(0,10);
        let income = 0, expenses = 0, assets = 0;
        transactions.forEach(t => { t.posts.forEach(p => { if (p.acc.startsWith('assets')) assets += (p.amt||0); }); if (t.date >= iso90) t.posts.forEach(p => { if (p.acc.startsWith('income')) income += (p.amt||0); if (p.acc.startsWith('expenses')) expenses += (p.amt||0); }); });
        const dailyAvg = (income+expenses)*-1 / 90; const predicted30 = assets + (dailyAvg * 30);
        log(`<div class="pnl-head">30-Day Forecast</div><div class="pnl-row"><span>Current</span><span>$${assets.toFixed(0)}</span></div><div class="pnl-row"><span>90d Avg/Day</span><span>$${dailyAvg.toFixed(2)}</span></div><div class="pnl-row pnl-total"><span>Projected</span><span style="color:${dailyAvg>0? 'var(--success)':'var(--error)'}">$${predicted30.toFixed(0)}</span></div>`);
    }
    else if (verb === 'recur') {
        const query = args.join(' '); if (!query) return log("Usage: recur <query>", 'warn');
        const found = [...transactions].reverse().find(t => match(t, query));
        if (!found) return log("No match.", 'error');
        if (found.posts.length < 2) return log("Too complex.", 'warn');
        Wizard.start({ desc: found.desc, acc1: found.posts[0].acc, amt: Math.abs(found.posts[0].amt).toFixed(2), acc2: found.posts[1].acc });
        log(`Recurring: ${found.desc}`, 'success');
    }
    else if (verb === 'budget') {
        if (!args[0]) {
            const bals = {}; const now = new Date(); const ym = now.toISOString().slice(0, 7);
            transactions.forEach(t => { if (!t.date.startsWith(ym)) return; t.posts.forEach(p => { if (p.acc.startsWith('expenses')) bals[p.acc] = (bals[p.acc] || 0) + (p.amt||0); }); });
            const budgets = BudgetManager.get(); if (Object.keys(budgets).length === 0) return log("No budgets set.", 'warn');
            Object.entries(budgets).forEach(([cat, limit]) => {
                let spent = 0; Object.keys(bals).forEach(acc => { if (acc.includes(cat)) spent += bals[acc]; });
                const pct = Math.min(100, (spent / limit) * 100); let cls = 'budget-fill'; if (pct > 85) cls += ' warn'; if (spent > limit) cls += ' over';
                log(`<div class="budget-row"><div class="budget-label"><span>${cat}</span><span>$${spent.toFixed(0)} / $${limit}</span></div><div class="budget-track"><div class="${cls}" style="width:${pct}%"></div></div></div>`);
            });
        } else if (args[0] === 'rm') { BudgetManager.remove(args[1]); log(`Removed.`, 'success'); }
        else if (args[1]) { BudgetManager.set(args[0], args[1]); log(`Set.`, 'success'); }
    }
    else if (verb === 'alias') {
        if (!args[0] || args[0] === 'list') { const list = AliasManager.list(); if(Object.keys(list).length === 0) log("No aliases.", 'system'); else Object.entries(list).forEach(([k,v]) => log(`${k} -> ${v}`, 'text')); }
        else if (args[0] === 'rm') { AliasManager.remove(args[1]); log(`Removed.`, 'success'); }
        else if (args[1]) { AliasManager.set(args[0], args[1]); log(`Saved.`, 'success'); }
    }
    else if (verb === 'undo') {
        const raw = LedgerManager.getRaw(); const blocks = raw.trim().split(/\n\s*\n/);
        if (blocks.length <= 1) return log("Nothing to undo.", 'warn');
        blocks.pop(); LedgerManager.save(blocks.join('\n\n') + '\n'); LedgerManager.load(); log("Undone.", 'success');
    }
    else if (verb === 'pnl') {
        const q = args.join(' '); let inc = 0, exp = 0;
        transactions.filter(t => match(t, q)).forEach(t => { t.posts.forEach(p => { if (p.acc.startsWith('income')) inc += (p.amt||0); if (p.acc.startsWith('expenses')) exp += (p.amt||0); }); });
        const net = inc + exp; 
        log(`<div class="pnl-head">P&L ${q?`(${q})`:''}</div>`);
        log(`<div class="pnl-row"><span>Income</span><span style="color:var(--success)">${inc.toFixed(2)}</span></div>`);
        log(`<div class="pnl-row"><span>Expenses</span><span style="color:var(--error)">${exp.toFixed(2)}</span></div>`);
        log(`<div class="pnl-row pnl-total"><span>Net</span><span style="color:${net<0?'var(--success)':'var(--text)'}">${net.toFixed(2)}</span></div>`);
    }
    else if (verb === 'theme') {
        if (args[0] === 'reset') { ThemeManager.reset(); log("Theme reset.", 'success'); }
        else if (args[0] === 'font') { ThemeManager.setFont(args[1]); log("Font set.", 'success'); }
        else if (args[0] === 'bg') { ThemeManager.setBg(args[1]); log("BG set.", 'success'); }
        else if (args[0] === 'text') { ThemeManager.setText(args[1]); log("Text set.", 'success'); }
        else if (args[0]) { ThemeManager.setPreset(args[0]); log(`Theme: ${args[0]}`, 'success'); }
    }
    else if (verb === 'strict') { const s = SETTINGS.toggleStrict(); log(`Strict: ${s?'ON':'OFF'}`, s?'success':'warn'); }
    else if (verb === 'ledger') { if(args[0]==='new'||args[0]==='switch') LedgerManager.switch(args[1]); else log(LedgerManager.list().join(', '), 'system'); }
    else if (verb === 'bal') {
        const b = {}; transactions.filter(t=>match(t, args.join(' '))).forEach(t=>t.posts.forEach(p=>b[p.acc]=(b[p.acc]||0)+(p.amt||0)));
        Object.keys(b).sort().forEach(k=>Math.abs(b[k])>0.01 && logRow(k, b[k]));
    }
    else if (verb === 'graph') {
        const type = args[0]; const filter = args.slice(1).join(' '); const b = {};
        if (type === 'pie') {
            let total = 0; const filterStr = filter || 'expenses';
            transactions.filter(t => match(t, filterStr)).forEach(t => { t.posts.forEach(p => { if (p.acc.includes(filterStr)) { b[p.acc] = (b[p.acc]||0) + (p.amt||0); total += (p.amt||0); } }); });
            const sorted = Object.entries(b).sort((a,b) => b[1] - a[1]).slice(0, 5); if (sorted.length === 0) return log("No data.", 'warn');
            let svg = `<svg viewBox="-1 -1 2 2" style="transform: rotate(-90deg); width:150px; height:150px;">`; let cum = 0; const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6'];
            sorted.forEach(([k,v], i) => { const percent = v / total; const start = cum * 2 * Math.PI; const end = (cum + percent) * 2 * Math.PI; const x1 = Math.cos(start), y1 = Math.sin(start); const x2 = Math.cos(end), y2 = Math.sin(end); const large = percent > 0.5 ? 1 : 0; const d = `M 0 0 L ${x1} ${y1} A 1 1 0 ${large} 1 ${x2} ${y2} Z`; svg += `<path d="${d}" fill="${colors[i%colors.length]}"></path>`; cum += percent; }); svg += `</svg>`;
            let legend = `<div style="font-size:11px; margin-left:10px;">`; sorted.forEach(([k,v], i) => { legend += `<div style="display:flex;align-items:center;margin-bottom:2px;"><div style="width:8px;height:8px;background:${colors[i%colors.length]};margin-right:6px;border-radius:50%"></div><span style="flex:1;opacity:0.8">${k.split(':').pop()}</span><span>${Math.round((v/total)*100)}%</span></div>`; }); legend += `</div>`;
            log(`<div style="margin:10px 0; padding:10px; background:var(--panel); border-radius:8px; display:flex; align-items:center;">${svg}${legend}</div>`);
        } else {
            const isExp = (type === 'exp'); const fStr = filter || (isExp?'expenses':''); transactions.filter(t=>match(t, fStr)).forEach(t=>t.posts.forEach(p=>b[p.acc]=(b[p.acc]||0)+(p.amt||0)));
            const entries = Object.entries(b).filter(e=>e[1]>0).sort((a,b)=>b[1]-a[1]).slice(0,5); 
            const max = entries[0]?.[1]||1;
            log(`<div style="margin:10px 0;border:1px solid var(--accent);padding:10px;border-radius:8px"><div style="color:var(--accent);font-size:11px;margin-bottom:5px">graph: ${fStr}</div>${entries.map(e=>`<div style="display:flex;align-items:center;margin:4px 0;font-size:11px"><div style="width:60px;overflow:hidden;text-align:right;margin-right:8px">${e[0].split(':').pop()}</div><div style="flex:1;background:var(--bg);height:10px;border:1px solid var(--accent)"><div style="height:100%;background:var(--primary);width:${(e[1]/max)*100}%"></div></div><div style="width:40px;text-align:right">${Math.round(e[1])}</div></div>`).join('')}</div>`);
        }
    }
    else if (verb === 'export') {
        const rawData = LedgerManager.getRaw();
        if (args[0] === 'copy') { navigator.clipboard.writeText(rawData).then(() => log("Copied.", 'success')); } 
        else { const blob = new Blob([rawData], {type: 'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `ledger_${new Date().toISOString().split('T')[0]}.hledger`; a.click(); log("Downloaded.", 'success'); }
    }
    else if (verb === 'add') { Wizard.start(); }
    else if (verb === 'clear') { content.innerHTML = ''; }
    else if (verb === 'help') { log("edit, rm, dash, stats, import, forecast, budget, recur, undo, pnl, alias, bal, reg, coa, graph, strict, export, add, ledger, theme", 'system'); }
    else { log("unknown command.", 'error'); }
}

/* =========================================
   WIZARD
   ========================================= */
const Wizard = {
    state: 0, postings: [], data: {},
    start(seedData = {}) { 
        this.state = 0; this.postings = []; this.data = {...seedData};
        wizard = this; document.body.classList.add('wizard-mode');
        this.ask();
    },
    ask() {
        document.getElementById('prompt-char').innerText = '?';
        if (this.state === 0) { log("Date? [Today]", 'system'); input.placeholder = new Date().toISOString().split('T')[0]; }
        else if (this.state === 1) { log("Description?", 'system'); input.placeholder = this.data.desc || ''; }
        else if (this.state === 2) {
            this.renderDraft();
            const pIdx = Math.floor(this.postings.length / 2);
            const isAcc = this.postings.length % 2 === 0;
            if (isAcc) {
                if (this.postings.length >= 2 && Math.abs(this.getBalance()) < 0.01) log(`Balanced. Enter to Save or Add Account ${pIdx+1}.`, 'system');
                else log(`Account ${pIdx+1}?`, 'system');
            } else {
                const bal = this.getBalance();
                log(`Amount ${pIdx+1}? [${bal !== 0 ? (bal * -1).toFixed(2) : ''}]`, 'system');
                input.placeholder = bal !== 0 ? (bal * -1).toFixed(2) : '';
            }
        }
        else if (this.state === 3) { this.renderDraft(); log("Save Transaction? (Y/n)", 'system'); }
        activeFilter = 'all'; updateContextBadge([]);
    },
    renderDraft() {
        let html = `<div class="draft-box"><div class="draft-head">${this.data.date || '...'} ${this.data.desc || ''}</div>`;
        for (let i=0; i<this.postings.length; i+=2) html += `<div class="draft-row"><span>${this.postings[i]}</span><span>${this.postings[i+1] || '...'}</span></div>`;
        log(html + `</div>`);
    },
    step(val) {
        if (this.state === 0) { this.data.date = val || new Date().toISOString().split('T')[0]; this.state = 1; this.ask(); return; }
        if (this.state === 1) { this.data.desc = val || 'Transaction'; this.state = 2; this.ask(); return; }
        if (this.state === 2) {
            const isAcc = this.postings.length % 2 === 0;
            if (isAcc) {
                if (!val) {
                    if (this.postings.length >= 2 && Math.abs(this.getBalance()) < 0.01) { this.state = 3; this.ask(); return; }
                }
                if (!val) return;
                val = AliasManager.resolve(val);
                if (SETTINGS.strictMode && !ENGINE.accounts.includes(val)) { log(`Strict: '${val}' unknown.`, 'error'); return; }
                this.postings.push(val); this.ask();
            } else {
                let amt = val;
                if (!amt) {
                    const bal = this.getBalance();
                    if (Math.abs(bal) > 0.001) amt = (bal * -1).toFixed(2);
                    else return;
                }
                const m = MathEngine.eval(amt); if (m) amt = m;
                this.postings.push(amt); this.ask();
            }
            return;
        }
        if (this.state === 3) {
            if (['n','no','cancel'].includes(val)) {
                log("Cancelled.", 'warn'); wizard = null; document.body.classList.remove('wizard-mode'); document.getElementById('prompt-char').innerText = '$'; input.placeholder = ''; return;
            }
            let out = `\n${this.data.date} ${this.data.desc}\n`;
            for (let i=0; i<this.postings.length; i+=2) out += `    ${this.postings[i]}    $${this.postings[i+1]}\n`;
            LedgerManager.save(localStorage.getItem('HL_DATA_'+LedgerManager.current) + out);
            LedgerManager.load(); log("Saved.", 'success');
            wizard = null; document.body.classList.remove('wizard-mode'); document.getElementById('prompt-char').innerText = '$'; input.placeholder = '';
        }
        updatePrediction();
    },
    getBalance() { let sum = 0; for (let i=1; i<this.postings.length; i+=2) sum += parseFloat(this.postings[i]); return sum; },
    getSuggs(val) {
        if (this.state === 0) return ['today', 'yesterday'].map(d=>({text:d, type:'date'}));
        if (this.state === 2) {
            if (this.postings.length % 2 === 0) return ENGINE.accounts.filter(a=>a.includes(val)).map(a=>({text:a, type:'acc'}));
        }
        if (this.state === 3) return [{text:'yes',type:'opt'}, {text:'no',type:'opt'}];
        return [];
    }
};

function renderCOA(filter) {
    // Render full tree even if filter matches children
    const accounts = ENGINE.accounts; 
    // If filter, we only show nodes that match or have matching children
    const tree = {};
    accounts.forEach(acc => { 
        if (filter && !acc.includes(filter)) return; // Basic filtering
        const parts = acc.split(':'); let curr = tree; 
        parts.forEach(p => { if (!curr[p]) curr[p] = {}; curr = curr[p]; }); 
    });
    
    function buildTreeHtml(node, depth = 0, prefix = '') {
        let html = ''; const keys = Object.keys(node).sort();
        keys.forEach(k => { 
            const fullPath = prefix ? prefix + ':' + k : k;
            const isLeaf = Object.keys(node[k]).length === 0;
            const isExplicit = definedAccounts.has(fullPath);
            const cls = isExplicit ? 'tree-name explicit' : 'tree-name';
            const action = `onclick="fill('${fullPath}')"`;
            html += `<div class="tree-item" style="margin-left:${depth * 12}px">
                <span class="tree-marker">└</span>
                <span class="${cls}" ${action}>${k}</span>
            </div>`;
            html += buildTreeHtml(node[k], depth + 1, fullPath);
        });
        return html;
    }
    
    const html = buildTreeHtml(tree);
    if (!html) return log("No accounts found.", 'warn');
    log(`<div class="tree-container">${html}</div>`);
}
function logRow(k, v) { log(`<div style="display:flex;justify-content:space-between;border-bottom:1px dashed var(--panel);padding:2px 0"><span style="opacity:0.9">${k}</span><span style="font-weight:bold;color:${v<0?'var(--error)':'var(--text)'}">$${v.toFixed(2)}</span></div>`); }

/* =========================================
   CONTEXT LOGIC
   ========================================= */
const availableContexts = ['all', 'acc', 'date', 'cmd', 'param'];
function cycleContext() {
    const currIdx = availableContexts.indexOf(activeFilter);
    activeFilter = availableContexts[(currIdx + 1) % availableContexts.length];
    input.focus(); updatePrediction();
}
function updateContextBadge(options) {
    const types = new Set(options.map(o => o.type));
    if (types.size <= 1) {
        if (types.size === 1) {
            const t = [...types][0].toUpperCase(); ctxBadge.innerText = `[${t}]`; ctxBadge.classList.remove('hidden');
            if (activeFilter !== 'all') activeFilter = 'all';
        } else ctxBadge.classList.add('hidden');
    } else { ctxBadge.innerText = `[${activeFilter.toUpperCase()}]`; ctxBadge.classList.remove('hidden'); }
}

/* =========================================
   PREDICTION RENDERER
   ========================================= */
let ghostSuffix = '';
function updatePrediction() {
    input.value = input.value.toLowerCase(); const val = input.value; const mathRes = MathEngine.eval(val);
    let options = [];
    if (wizard) { 
        ghost.innerText = ''; tabBtn.classList.remove('visible'); options = Wizard.getSuggs(val); 
        if (Wizard.state === 2 && Wizard.postings.length % 2 !== 0) {
            const bal = Wizard.getBalance();
            if (Math.abs(bal) > 0.001) { const fix = (bal * -1).toFixed(2); options.unshift({ text: fix, type: 'math' }); }
        }
    } 
    else {
        const result = ENGINE.predict(val); ghostSuffix = result.suggest;
        if (ghostSuffix) { tabBtn.classList.add('visible'); ghost.innerHTML = `<span style="opacity:0">${val}</span>` + ghostSuffix; } 
        else { tabBtn.classList.remove('visible'); ghost.innerHTML = ''; }
        options = result.options;
    }
    updateContextBadge(options);
    const filtered = activeFilter === 'all' ? options : options.filter(o => o.type === activeFilter);
    let html = '';
    if (mathRes && !ENGINE.schema[val.split(' ')[0]]) html += `<div class="chip math" onmousedown="event.preventDefault()" onclick="fill('${mathRes}')">= ${mathRes}</div>`;
    html += filtered.slice(0, 10).map(opt => {
        if (opt.type === 'math') return `<div class="chip math" onmousedown="event.preventDefault()" onclick="fill('${opt.text}')">Bal: ${opt.text}</div>`;
        if (opt.isHint) return `<div class="chip hint" onmousedown="event.preventDefault()">${opt.text}</div>`;
        return `<div class="chip" onmousedown="event.preventDefault()" onclick="completeChip('${opt.text}')">${opt.text}</div>`;
    }).join('');
    suggs.innerHTML = html;
}

window.acceptGhost = function() { if (ghostSuffix) { input.value += ghostSuffix; ghostSuffix = ''; input.focus(); updatePrediction(); } };
window.completeChip = (text) => { const val = input.value; const parts = val.split(' '); if (val.endsWith(' ')) input.value += text; else { parts.pop(); input.value = (parts.length ? parts.join(' ') + ' ' : '') + text; } if (!text.endsWith(':')) input.value += ' '; input.focus(); updatePrediction(); setTimeout(() => inputWrapper.scrollIntoView({behavior: "smooth", block: "end"}), 100); };
window.fill = (s) => { if (wizard) { input.value = s; } else { input.value += s + ' '; } input.focus(); updatePrediction(); setTimeout(() => inputWrapper.scrollIntoView({behavior: "smooth", block: "end"}), 100); };

// GLOBAL EXPORT
window.Editor = {
    el: document.getElementById('editor-modal'), area: document.getElementById('raw-editor'),
    open() { this.area.value = LedgerManager.getRaw(); this.el.classList.add('open'); setTimeout(()=>this.area.focus(), 300); },
    save() { LedgerManager.save(this.area.value); LedgerManager.load(); this.close(); log("Saved.", 'success'); },
    close() { this.el.classList.remove('open'); },
    copy() { navigator.clipboard.writeText(this.area.value).then(()=> { const btn = document.getElementById('copy-btn'); const original = btn.innerText; btn.innerText = "Copied!"; setTimeout(()=>btn.innerText=original, 1500); }); }
};

input.addEventListener('input', updatePrediction);
input.addEventListener('keydown', (e) => { if (e.key === 'Tab' || e.key === 'ArrowRight') { e.preventDefault(); acceptGhost(); } if (e.key === 'Enter') { run(input.value); input.value = ''; updatePrediction(); } });
if (window.visualViewport) { window.visualViewport.addEventListener('resize', () => { document.body.style.height = window.visualViewport.height + 'px'; inputWrapper.scrollIntoView({behavior: "smooth", block: "end"}); container.scrollTop = container.scrollHeight; }); }
</script>
</body>
</html>